<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindWell - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Your existing CSS styles */
    </style>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://gqidhzjgmgmxsxtnaofp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxaWRoempnbWdteHN4dG5hb2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NjEwMjYsImV4cCI6MjA1ODEzNzAyNn0.OYa8DL6BebkNosBEjIc95P8K_xzbueL5szFg1Uz-POg';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Function to fetch and display user data
        async function loadUserProfile() {
            try {
                // Check if the user is authenticated
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

                if (sessionError || !session) {
                    // Redirect to login if not authenticated
                    window.location.href = '../html/login.html';
                    return;
                }

                // Fetch user data from users table
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (userError && userError.code !== 'PGRST116') throw userError;

                if (userData) {
                    // If user data exists, display it
                    displayProfileData(userData);
                } else {
                    // If user data doesn't exist, show the form
                    showProfileForm();
                }

            } catch (error) {
                console.error('Error loading profile:', error.message);
                alert('Error loading profile data');
            }
        }

        // Function to display profile data
        function displayProfileData(userData) {
            document.querySelector('.profile-name').textContent = userData.name || userData.email.split('@')[0];
            document.querySelector('.profile-email').textContent = userData.email;

            // Hide the form
            document.getElementById('profile-form').style.display = 'none';

            // Display the saved data
            const profileDetails = document.getElementById('profile-details');
            profileDetails.innerHTML = `
                <div class="mt-4">
                    <p><strong>Name:</strong> ${userData.name}</p>
                    <p><strong>Date of Birth:</strong> ${userData.dob}</p>
                    <p><strong>Lifeline Name:</strong> ${userData.lifeline_name}</p>
                    <p><strong>Lifeline Email:</strong> ${userData.lifeline_email}</p>
                </div>
            `;
        }

        // Function to show the profile form
        function showProfileForm() {
            document.getElementById('profile-details').style.display = 'none';
            document.getElementById('profile-form').style.display = 'block';
        }

        // Function to save profile data
        async function saveProfile() {
            try {
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

                if (sessionError || !session) {
                    // Redirect to login if not authenticated
                    window.location.href = '../html/login.html';
                    return;
                }

                const name = document.getElementById('name').value;
                const dob = document.getElementById('dob').value;
                const lifelineName = document.getElementById('lifeline-name').value;
                const lifelineEmail = document.getElementById('lifeline-email').value;

                // Insert profile data into public.users table
                const { data, error } = await supabaseClient
                    .from('users')
                    .upsert([
                        {
                            id: session.user.id,
                            email: session.user.email,
                            name,
                            dob,
                            lifeline_name: lifelineName,
                            lifeline_email: lifelineEmail
                        }
                    ]);

                if (error) throw error;

                // Reload the profile page to display the saved data
                window.location.reload();
            } catch (error) {
                console.error('Error saving profile:', error.message);
                alert('Error saving profile');
            }
        }

        // Load profile data when page loads
        document.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-logo">MindWell</a>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="index2.html">Wellness</a></li>
                <li><a href="index3.html">Support</a></li>
                <li><a href="index4.html">Fellowship</a></li>
            </ul>
            <button onclick="signOut()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Sign Out</button>
        </div>
    </nav>

    <!-- Profile Content -->
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">ðŸ‘¤</div>
            <h1 class="profile-name">Loading...</h1>
            <p class="profile-email">Loading...</p>
            <a href="assessment.html" class="assessment-button">Take Assessment</a>
        </div>

        <!-- Profile Details (Displayed after data is saved) -->
        <div id="profile-details" class="mt-8 p-4 bg-gray-50 rounded-lg">
            <!-- Profile data will be displayed here -->
        </div>

        <!-- Profile Form (Displayed only for first-time users) -->
        <div id="profile-form" class="lifeline-section mt-8 p-4 bg-gray-50 rounded-lg" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">Complete Your Profile</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <input type="date" id="dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lifeline Name</label>
                    <input type="text" id="lifeline-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lifeline Email</label>
                    <input type="email" id="lifeline-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
            </div>
            <button onclick="saveProfile()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Profile</button>
        </div>
    </div>

    <!-- Sign Out Function -->
    <script>
        async function signOut() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Error signing out:', error.message);
            } else {
                window.location.href = '../html/login.html';
            }
        }
    </script>
</body>
</html>